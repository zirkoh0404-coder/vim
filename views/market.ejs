<%- include('partials/navbar') %>

<style>
    /* SLOWED DOWN CONVEYOR */
    @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    .animate-conveyor { display: flex; animation: scroll 60s linear infinite; width: max-content; }
    .animate-conveyor:hover { animation-play-state: paused; }
    
    /* LEVITATION EFFECT */
    @keyframes levitate {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-15px); }
    }

    /* 3D TILT & GLOW EFFECT */
    .player-card { 
        transition: transform 0.1s ease-out, box-shadow 0.3s ease, border-color 0.3s ease, opacity 0.5s ease, scale 0.5s ease;
        cursor: pointer; 
        position: relative;
        overflow: hidden;
        transform-style: preserve-3d;
        perspective: 1000px;
        animation: levitate 4s ease-in-out infinite;
    }

    /* Hide filtered cards smoothly */
    .player-card.filtered-out {
        display: none !important;
    }
    
    .player-card:hover { 
        z-index: 10; 
        border-color: rgba(59, 130, 246, 0.8); 
        box-shadow: 0 25px 50px -12px rgba(59, 130, 246, 0.5);
        animation-play-state: paused;
    }

    /* POSITION COLORS & GLASSMORPHISM SILHOUETTE */
    .pos-fwd { --pos-color: #ef4444; --pos-glow: rgba(239, 68, 68, 0.3); }
    .pos-mid { --pos-color: #f59e0b; --pos-glow: rgba(245, 158, 11, 0.3); }
    .pos-def { --pos-color: #10b981; --pos-glow: rgba(16, 185, 129, 0.3); }
    .pos-gk { --pos-color: #06b6d4; --pos-glow: rgba(6, 182, 212, 0.3); }
    .pos-pro { --pos-color: #3b82f6; --pos-glow: rgba(59, 130, 246, 0.3); }

    .glass-silhouette {
        background: linear-gradient(180deg, var(--pos-glow) 0%, rgba(0,0,0,0.8) 100%);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .glass-silhouette svg {
        filter: drop-shadow(0 0 15px var(--pos-color));
        opacity: 0.6;
    }

    .card-img {
        filter: grayscale(100%);
        transition: filter 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s ease;
    }
    .player-card:hover .card-img {
        filter: grayscale(0%);
        transform: scale(1.05);
    }

    .card-active-anim {
        animation: sleekClick 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        pointer-events: none;
    }

    @keyframes sleekClick {
        0% { transform: scale(1); box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
        50% { transform: scale(1.08); box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); }
        100% { transform: scale(1.02); opacity: 0.8; }
    }

    /* SEARCH & FILTER STYLES */
    .market-filter-btn {
        padding: 8px 16px;
        border-radius: 99px;
        font-size: 10px;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.1);
        color: rgba(255,255,255,0.5);
    }
    .market-filter-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
    }

    /* FIFA STYLE MODAL */
    .modal { 
        display: none; 
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px; 
        backdrop-filter: blur(0px);
        transition: all 0.4s ease;
    }
    
    .modal.active { background: rgba(0,0,0,0.92); backdrop-filter: blur(20px); }

    #modalContainer {
        transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
        transform: translateY(50px) scale(0.95);
        opacity: 0;
        animation: levitate 5s ease-in-out infinite;
    }

    #modalContainer.show {
        transform: translateY(0) scale(1);
        opacity: 1;
    }

    .stat-badge {
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
        border: 1px solid rgba(255,255,255,0.05);
        backdrop-filter: blur(10px);
    }

    .form-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 1rem; border-radius: 1rem; outline: none; transition: 0.3s; color: white; }
    .form-input:focus { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
    select.form-input option { background: #0a0a0a; color: white; }

    .hidden-form { display: none !important; }
</style>

<% if (typeof error !== 'undefined' && error) { %>
    <div class="fixed top-24 left-1/2 -translate-x-1/2 z-[100] bg-red-600 text-white px-10 py-5 rounded-[30px] font-black uppercase italic shadow-[0_20px_50px_rgba(220,38,38,0.5)] border-2 border-white/20 animate-bounce">
        ⚠️ <%= error %>
    </div>
<% } %>

<main class="py-20 overflow-hidden">
    <div class="max-w-7xl mx-auto px-6 mb-12 flex flex-col md:flex-row justify-between items-center gap-8">
        <div>
            <h2 class="text-5xl font-black italic uppercase tracking-tighter text-blue-500">PLAYER MARKET</h2>
            <p class="text-[10px] text-white/40 font-bold uppercase tracking-[0.3em]">VIM Super League Official Market</p>
        </div>

        <div class="flex flex-col items-end gap-4">
            <div class="relative w-full md:w-80">
                <input type="text" id="marketSearch" oninput="filterMarket()" placeholder="SEARCH PLAYER NAME..." 
                       class="w-full bg-white/5 border border-white/10 px-6 py-3 rounded-full text-[10px] font-black uppercase tracking-widest outline-none focus:border-blue-500 transition">
                <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <div class="flex gap-2">
                <button onclick="setFilter('ALL', this)" class="market-filter-btn active">ALL</button>
                <button onclick="setFilter('FWD', this)" class="market-filter-btn">FWD</button>
                <button onclick="setFilter('MID', this)" class="market-filter-btn">MID</button>
                <button onclick="setFilter('DEF', this)" class="market-filter-btn">DEF</button>
                <button onclick="setFilter('GK', this)" class="market-filter-btn">GK</button>
            </div>
        </div>
    </div>

    <% if(players.length > 0) { %>
        <div class="relative flex items-center mb-32 border-y border-white/5 py-12">
            <div class="animate-conveyor gap-10 px-4" id="conveyorBelt">
                <% let displayList = players.length < 5 ? [...players, ...players, ...players, ...players] : [...players, ...players]; %>
                <% displayList.forEach(p => { 
                    let posClass = 'pos-pro';
                    if(p.position === 'FWD') posClass = 'pos-fwd';
                    if(p.position === 'MID') posClass = 'pos-mid';
                    if(p.position === 'DEF') posClass = 'pos-def';
                    if(p.position === 'GK') posClass = 'pos-gk';
                %>
                    <div class="player-card <%= posClass %> w-[260px] h-[360px] glass rounded-[30px] overflow-hidden flex-shrink-0 relative group"
                         data-name="<%= p.name.toLowerCase() %>"
                         data-pos="<%= p.position %>"
                         onmousemove="tiltCard(event, this)" 
                         onmouseleave="resetTilt(this)"
                         onclick="openBio(this, '<%= p.name %>', '<%= p.cardImage %>', `<%= p.experience || p.bio %>`, '<%= p.discord %>', '<%= p.goals || 0 %>', '<%= p.assists || 0 %>', '<%= p.saves || 0 %>', '<%= p.mvps || 0 %>', '<%= p.views ? p.views.length : 0 %>', '<%= p.position %>', '<%= p.country %>', '<%= p.timezone %>')">
                        
                        <% if (p.cardImage && p.cardImage.trim() !== "") { %>
                            <img src="<%= p.cardImage %>" class="card-img w-full h-full object-cover">
                        <% } else { %>
                            <div class="card-img w-full h-full glass-silhouette">
                                <span class="absolute top-10 text-[60px] font-black italic text-white/5 select-none uppercase"><%= p.position || 'PRO' %></span>
                                <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            </div>
                        <% } %>

                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent p-6 flex flex-col justify-end">
                            <div class="flex justify-between items-start">
                                <h3 class="font-black text-2xl italic uppercase tracking-tighter text-white"><%= p.name %></h3>
                                <span class="bg-blue-600 text-white text-[8px] font-black px-2 py-1 rounded-md italic uppercase" style="background-color: var(--pos-color);"><%= p.position || 'N/A' %></span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-[9px] font-bold uppercase tracking-widest" style="color: var(--pos-color);">View Profile</p>
                                <div class="flex items-center gap-1 bg-black/40 px-2 py-0.5 rounded-md">
                                    <span class="text-[9px] text-white font-black"><%= p.views ? p.views.length : 0 %></span>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
    <% } %>

    <div id="bioModal" class="modal" onclick="closeBio()">
        <div class="max-w-5xl w-full flex flex-col md:flex-row gap-8 items-center relative" id="modalContainer" onclick="event.stopPropagation()">
            <div class="relative group w-[320px] h-[450px] flex-shrink-0" id="modalGlowParent">
                <div id="modalPositionGlow" class="absolute -inset-4 blur-3xl rounded-full opacity-50 group-hover:opacity-100 transition duration-1000"></div>
                <div class="relative w-full h-full glass rounded-[40px] overflow-hidden border border-white/20 shadow-2xl bg-black">
                    <img id="modalImg" src="" class="w-full h-full object-cover">
                    <div id="modalImgPlaceholder" class="w-full h-full glass-silhouette">
                        <svg class="w-48 h-48" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>

                    <div class="absolute bottom-0 left-0 right-0 p-8 bg-gradient-to-t from-black to-transparent">
                        <div class="flex items-center gap-3">
                            <span id="modalPosBadge" class="text-white text-[10px] font-black px-3 py-1 rounded-full italic uppercase"></span>
                            <span id="modalCountryBadge" class="text-white/60 text-[10px] font-bold uppercase tracking-widest"></span>
                        </div>
                        <h2 id="modalName" class="text-4xl font-black italic uppercase text-white tracking-tighter mt-1"></h2>
                        <div id="modalColorBar" class="h-1 w-12 mt-2"></div>
                    </div>
                </div>
            </div>

            <div class="flex-1 glass p-10 rounded-[40px] border border-white/10 shadow-2xl relative overflow-hidden">
                <div class="absolute -top-10 -right-10 text-[120px] font-black italic text-white/[0.03] pointer-events-none uppercase">STATS</div>
                <div class="flex justify-between items-start mb-8 relative z-10">
                    <div>
                        <p id="modalDiscord" class="text-blue-400 font-bold text-xs uppercase tracking-[0.2em] mb-1"></p>
                        <p id="modalTZ" class="text-[9px] text-white/60 font-black uppercase mb-1"></p>
                        <p class="text-[10px] text-white/40 font-bold uppercase">Official VIM Player Contract</p>
                    </div>
                    <div class="text-right">
                        <p id="modalViews" class="text-5xl font-black italic text-white leading-none">0</p>
                        <p class="text-[8px] uppercase font-black text-blue-500 tracking-widest">PROFILE VIEWS</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 relative z-10">
                    <div class="stat-badge p-4 rounded-2xl text-center"><p class="text-[8px] uppercase font-black text-white/30 mb-1">Goals</p><p id="mGoals" class="text-3xl font-black italic text-white">0</p></div>
                    <div class="stat-badge p-4 rounded-2xl text-center"><p class="text-[8px] uppercase font-black text-white/30 mb-1">Assists</p><p id="mAssists" class="text-3xl font-black italic text-white">0</p></div>
                    <div class="stat-badge p-4 rounded-2xl text-center"><p class="text-[8px] uppercase font-black text-white/30 mb-1">Saves</p><p id="mSaves" class="text-3xl font-black italic text-white">0</p></div>
                    <div class="stat-badge p-4 rounded-2xl text-center border-blue-500/30 bg-blue-500/5"><p class="text-[8px] uppercase font-black text-blue-400 mb-1">MVP</p><p id="mMvps" class="text-3xl font-black italic text-blue-500">0</p></div>
                </div>
                <div class="relative z-10">
                    <p class="text-[10px] uppercase tracking-[0.3em] text-white/40 mb-3 font-black">Experience & Biography</p>
                    <div id="modalBio" class="text-gray-300 leading-relaxed text-sm h-32 overflow-y-auto pr-4 italic bg-white/5 p-5 rounded-2xl border border-white/5 scrollbar-hide"></div>
                </div>
                <button onclick="closeBio()" class="mt-8 w-full bg-white text-black hover:bg-blue-600 hover:text-white py-4 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] transition-all duration-300">Return to Market</button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-6">
        <% if (user) { %>
            <div class="max-w-xl mx-auto glass p-12 rounded-[40px] shadow-2xl border-white/10 text-center space-y-6">
                <h3 class="text-2xl font-black italic uppercase text-white">Welcome Back! <span class="text-blue-500"><%= user.name %></span></h3>
                <div class="pt-4 space-y-3">
                    <a href="/profile" class="block w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-blue-500 transition shadow-lg">Manage my Profile</a>
                    <form action="/profile/delete" method="POST" onsubmit="return confirm('Withdraw your application from the market?')">
                        <button type="submit" class="w-full bg-red-600/10 text-red-500 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest border border-red-500/20 hover:bg-red-600 hover:text-white transition">Withdraw Application</button>
                    </form>
                </div>
            </div>
        <% } else { %>
            <div class="max-w-2xl mx-auto">
                <div id="registerBox" class="glass p-12 rounded-[40px] border-white/10">
                    <h3 class="text-2xl font-black italic mb-8 uppercase text-white">Register as Player</h3>
                    <form action="/register" method="POST" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input name="name" placeholder="Roblox User" required class="form-input">
                            <input name="discord" placeholder="Discord User" required class="form-input">
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <select name="position" required class="form-input">
                                <option value="" disabled selected>POSITION</option>
                                <option value="FWD">FORWARD</option>
                                <option value="MID">MIDFIELD</option>
                                <option value="DEF">DEFENSE</option>
                                <option value="GK">GOALKEEPER</option>
                            </select>
                            <input name="country" placeholder="Country" required class="form-input">
                            <input name="timezone" placeholder="Timezone (e.g. GMT+5)" required class="form-input">
                        </div>
                        <textarea name="experience" placeholder="Tell us about your past experience / Bio..." required class="form-input h-24"></textarea>
                        <input type="password" name="password" placeholder="Create Password" required class="form-input">
                        <button type="submit" class="w-full bg-white text-black py-5 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-blue-600 hover:text-white transition">SUBMIT CONTRACT</button>
                    </form>
                    <div class="mt-6 text-center">
                        <button onclick="toggleAuth()" class="text-[10px] font-black uppercase tracking-widest text-white/40 hover:text-blue-500 transition underline underline-offset-4">Already have an account? Login</button>
                    </div>
                </div>
                <div id="loginBox" class="glass p-12 rounded-[40px] border-white/10 hidden-form">
                    <h3 class="text-2xl font-black italic mb-8 uppercase text-blue-500">Player Login</h3>
                    <form action="/login" method="POST" class="space-y-6">
                        <input name="username" placeholder="Roblox Username" required class="form-input">
                        <input type="password" name="password" placeholder="Password" required class="form-input">
                        <button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-blue-500 transition shadow-lg">AUTHORIZE</button>
                    </form>
                    <div class="mt-6 text-center">
                        <button onclick="toggleAuth()" class="text-[10px] font-black uppercase tracking-widest text-white/40 hover:text-blue-500 transition underline underline-offset-4">Need a contract? Register Here</button>
                    </div>
                </div>
            </div>
        <% } %>
    </div>
</main>

<script>
    let currentFilter = 'ALL';

    // LIVE SEARCH & FILTER LOGIC
    function setFilter(pos, btn) {
        document.querySelectorAll('.market-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = pos;
        filterMarket();
    }

    function filterMarket() {
        const searchTerm = document.getElementById('marketSearch').value.toLowerCase();
        const cards = document.querySelectorAll('.player-card');
        
        cards.forEach(card => {
            const name = card.getAttribute('data-name');
            const pos = card.getAttribute('data-pos');
            
            const matchesSearch = name.includes(searchTerm);
            const matchesFilter = (currentFilter === 'ALL' || pos === currentFilter);
            
            if (matchesSearch && matchesFilter) {
                card.classList.remove('filtered-out');
            } else {
                card.classList.add('filtered-out');
            }
        });

        // RESTART CONVEYOR IF FILTERED
        const conveyor = document.getElementById('conveyorBelt');
        conveyor.style.animation = 'none';
        conveyor.offsetHeight; /* trigger reflow */
        conveyor.style.animation = null;
    }

    // FORM TOGGLE LOGIC
    function toggleAuth() {
        const reg = document.getElementById('registerBox');
        const log = document.getElementById('loginBox');
        reg.classList.toggle('hidden-form');
        log.classList.toggle('hidden-form');
    }

    function tiltCard(e, el) {
        const rect = el.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const xc = rect.width / 2;
        const yc = rect.height / 2;
        const dx = (x - xc) / xc;
        const dy = (y - yc) / yc;
        el.style.transform = `rotateY(${dx * 15}deg) rotateX(${-dy * 15}deg) scale(1.05)`;
    }

    function resetTilt(el) {
        el.style.transform = `rotateY(0deg) rotateX(0deg) scale(1)`;
    }

    async function openBio(el, name, img, bio, discord, g, a, s, m, currentViews, pos, country, tz) {
        el.classList.add('card-active-anim');
        
        const colors = { 'FWD': '#ef4444', 'MID': '#f59e0b', 'DEF': '#10b981', 'GK': '#06b6d4', 'PRO': '#3b82f6' };
        const activeColor = colors[pos] || colors['PRO'];
        
        document.getElementById('modalGlowParent').className = `relative group w-[320px] h-[450px] flex-shrink-0 pos-${(pos || 'pro').toLowerCase()}`;
        document.getElementById('modalPositionGlow').style.backgroundColor = activeColor;
        document.getElementById('modalPosBadge').style.backgroundColor = activeColor;
        document.getElementById('modalColorBar').style.backgroundColor = activeColor;
        document.getElementById('modalImgPlaceholder').className = `w-full h-full glass-silhouette pos-${(pos || 'pro').toLowerCase()}`;

        document.getElementById('modalName').innerText = name;
        
        const modalImg = document.getElementById('modalImg');
        const placeholder = document.getElementById('modalImgPlaceholder');
        if(img && img.trim() !== "" && img !== "undefined") {
            modalImg.src = img;
            modalImg.style.display = "block";
            placeholder.style.display = "none";
        } else {
            modalImg.style.display = "none";
            placeholder.style.display = "flex";
        }

        document.getElementById('modalBio').innerText = bio;
        document.getElementById('modalDiscord').innerText = "@" + discord;
        document.getElementById('modalPosBadge').innerText = pos || 'PLAYER';
        document.getElementById('modalCountryBadge').innerText = country || 'UNKNOWN';
        document.getElementById('modalTZ').innerText = "TIMEZONE: " + (tz || 'N/A');
        
        document.getElementById('mGoals').innerText = g;
        document.getElementById('mAssists').innerText = a;
        document.getElementById('mSaves').innerText = s;
        document.getElementById('mMvps').innerText = m;
        document.getElementById('modalViews').innerText = currentViews;

        try {
            const response = await fetch(`/market/view/${name}`, { method: 'POST' });
            const data = await response.json();
            if(data.success) {
                document.getElementById('modalViews').innerText = data.count;
            }
        } catch(e) {
            console.error("View count update failed", e);
        }
        
        setTimeout(() => {
            const modal = document.getElementById('bioModal');
            const container = document.getElementById('modalContainer');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('active');
                container.classList.add('show');
                el.classList.remove('card-active-anim');
            }, 50);
        }, 400);
    }

    function closeBio() { 
        const modal = document.getElementById('bioModal');
        const container = document.getElementById('modalContainer');
        container.classList.remove('show');
        modal.classList.remove('active');
        setTimeout(() => { modal.style.display = 'none'; }, 400);
    }
</script>
